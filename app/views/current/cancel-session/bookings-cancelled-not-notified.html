<!-- Use this page as the index for your project -->
<!-- ADDING CUSTOM CSS - Add your custom CSS or Sass in /app/assets/sass/main.scss -->
<!-- Extends the layout from /views/layout.html -->
{% extends 'current/layouts/layout-top-nav-sites.html' %}
<!--
 In /views/layout.html you can:
 - change the header and footer
 - add custom CSS and JavaScript
-->

<!-- Set the page title -->
{% block pageTitle %}
Manage appointments - {{site}} - 21 July
{% endblock %}

<!-- For adding a breadcrumb -->
<!-- Code examples can be found at https://service-manual.nhs.uk/design-system/components/breadcrumbs -->
{% block beforeContent %}
{{ backLink({
 href: "javascript:history.back()",
 text: "Back"
}) }}
{% endblock %}

<!-- For adding a back link -->
<!-- Code examples can be found at https://service-manual.nhs.uk/design-system/components/back-link -->
{% block outerContent %}
{% endblock %}

<!-- Link to external CSS file -->
{% block head %}

{% endblock %}

<!-- For adding page content -->
<!-- Page layout code can be found at https://service-manual.nhs.uk/design-system/styles/layout -->
{% block content %}
<div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-full">
        <span class="nhsuk-hint">{{site}}</span>
        <h1 class="nhsuk-heading-l">People who did not get a cancellation notification</h1>

        <p>These people did not get a cancellation notification as they had no contact details on their booking.</p>
        
        <!-- Print button -->
        <button class="nhsuk-button nhsuk-button--secondary" onclick="window.print()">
            Print page
        </button>
        
        <hr class="nhsuk-u-margin-bottom-1 nhsuk-u-margin-top-1">
        
     
        
       
        
        <!-- Appointments Table -->
        <div class="nhsuk-table-responsive">
            <table class="nhsuk-table appointments-table">
                <caption class="nhsuk-table__caption nhsuk-u-visually-hidden">
                   Cancelled bookings for {{site}} on {{date()}}
                </caption>
                <thead class="nhsuk-table__head">
                    <tr class="nhsuk-table__row">
                    
                    
                    
                        <th class="nhsuk-table__header" scope="col">Time</th>
                        <th class="nhsuk-table__header" scope="col">Name and NHS number</th>
                        <th class="nhsuk-table__header" scope="col">Date of birth</th>
                        <th class="nhsuk-table__header" scope="col">Contact details</th>
                        <th class="nhsuk-table__header" scope="col">Service</th>
                    
                       
                        
                    </tr>
                </thead>
                <tbody class="nhsuk-table__body">
                    <tr class="nhsuk-table__row appointment-row" data-service="Flu">
                        <td class="nhsuk-table__cell">09:00</td>
                        <td class="nhsuk-table__cell">
                            <strong>John Smith</strong><br>
                            123 456 7890
                        </td>
                        <td class="nhsuk-table__cell">04 June 1947</td>
                        <td class="nhsuk-table__cell">01933 234 887 </td>
                        <td class="nhsuk-table__cell">RSV</td>
                        </tr>
                    <tr class="nhsuk-table__row appointment-row" data-service="Covid">
                        <td class="nhsuk-table__cell">09:15</td>
                        <td class="nhsuk-table__cell">
                            <strong>Jane Doe</strong><br>
                            123 456 7890
                        </td>
                        <td class="nhsuk-table__cell">12 March 1955</td>
                        <td class="nhsuk-table__cell">Not provided</td>
                        <td class="nhsuk-table__cell">Covid 75+</td>
                        </tr>
                    <tr class="nhsuk-table__row appointment-row" data-service="Flu">
                        <td class="nhsuk-table__cell">09:30</td>
                        <td class="nhsuk-table__cell">
                            <strong>Mary Johnson</strong><br>
                            123 456 7890
                        </td>
                        <td class="nhsuk-table__cell">23 August 1950</td>
                        <td class="nhsuk-table__cell">01905 776 339</td>
                        <td class="nhsuk-table__cell">Flu</td>
                        </tr>

                    

                    
                
                </tbody>
            </table>
        </div>
        
    <nav class="nhsuk-pagination nhsuk-pagination--numbered" role="navigation" aria-label="Pagination">
        <div class="nhsuk-pagination--numbered__prev">
          <a class="nhsuk-pagination--numbered__link" href="/user-admin?page=3&amp;q=" rel="prev"><svg class="nhsuk-icon nhsuk-icon__arrow-left" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" width="34" height="34">
          <path d="M4.1 12.3l2.7 3c.2.2.5.2.7 0 .1-.1.1-.2.1-.3v-2h11c.6 0 1-.4 1-1s-.4-1-1-1h-11V9c0-.2-.1-.4-.3-.5h-.2c-.1 0-.3.1-.4.2l-2.7 3c0 .2 0 .4.1.6z"></path>
        </svg>Previous<span class="nhsuk-u-visually-hidden"> page</span>
            </a>
        </div>
      
        <ul class="nhsuk-pagination__list--numbered">
            <li class="nhsuk-pagination--numbered__item">
                <a class="nhsuk-pagination--numbered__link" href="" aria-label="Page 1">1</a>
            </li>
            <li class="nhsuk-pagination--numbered__item">
                <a class="nhsuk-pagination--numbered__link" href="" aria-label="Page 2">2</a>
            </li>
            <li class="nhsuk-pagination--numbered__item">
                <a class="nhsuk-pagination--numbered__link" href="" aria-label="Page 3">3</a>
            </li>
        </ul>

        <div class="nhsuk-pagination--numbered__next">
          <a class="nhsuk-pagination--numbered__link" href="/user-admin?page=5&amp;q=" rel="next">Next<span class="nhsuk-u-visually-hidden"> page</span><svg class="nhsuk-icon nhsuk-icon__arrow-right" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" width="34" height="34">
          <path d="M19.6 11.66l-2.73-3A.51.51 0 0 0 16 9v2H5a1 1 0 0 0 0 2h11v2a.5.5 0 0 0 .32.46.39.39 0 0 0 .18 0 .52.52 0 0 0 .37-.16l2.73-3a.5.5 0 0 0 0-.64z"></path>
        </svg></a>
        </div>
    </nav>
    </div>
</div>

<!-- JavaScript for bulk actions and filtering -->
<script>
let selectedCount = 0;

function updateSelection() {
    const checkboxes = document.querySelectorAll('.row-checkbox:not(.hidden-row .row-checkbox)');
    const visibleCheckboxes = Array.from(checkboxes).filter(cb => !cb.closest('tr').classList.contains('hidden-row'));
    const selectAllCheckbox = document.getElementById('selectAll');
    const cancelButton = document.getElementById('cancelButton');
    
    selectedCount = visibleCheckboxes.filter(cb => cb.checked).length;
    
    // Update button states
    cancelButton.disabled = selectedCount === 0;
    
    // Update select all checkbox state
    if (selectedCount === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
    } else if (selectedCount === visibleCheckboxes.length) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
    } else {
        selectAllCheckbox.indeterminate = true;
    }
    
    // Update row highlighting
    checkboxes.forEach(checkbox => {
        const row = checkbox.closest('tr');
        if (checkbox.checked) {
            row.classList.add('selected');
        } else {
            row.classList.remove('selected');
        }
    });
}

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.row-checkbox');
    
    checkboxes.forEach(checkbox => {
        const row = checkbox.closest('tr');
        if (!row.classList.contains('hidden-row')) {
            checkbox.checked = selectAllCheckbox.checked;
        }
    });
    
    updateSelection();
}

function clearSelection() {
    const checkboxes = document.querySelectorAll('.row-checkbox');
    const selectAllCheckbox = document.getElementById('selectAll');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    selectAllCheckbox.checked = false;
    
    updateSelection();
}

// NEW: Filter appointments function
function filterAppointments() {
    const select = document.getElementById('select-1');
    const selectedService = select.value;
    const appointmentRows = document.querySelectorAll('.appointment-row');
    const filterInfo = document.getElementById('filterInfo');
    const filterText = document.getElementById('filterText');
    
    let visibleCount = 0;
    
    appointmentRows.forEach(row => {
        const rowService = row.getAttribute('data-service');
        
        if (selectedService === 'all' || rowService === selectedService) {
            row.classList.remove('hidden-row');
            visibleCount++;
        } else {
            row.classList.add('hidden-row');
            // Uncheck hidden rows
            const checkbox = row.querySelector('.row-checkbox');
            if (checkbox) {
                checkbox.checked = false;
            }
        }
    });
    
    // Update filter info display
    if (selectedService === 'all') {
        filterInfo.style.display = 'none';
    } else {
        filterInfo.style.display = 'block';
        filterText.textContent = `Showing ${visibleCount} appointments for ${selectedService} service`;
    }
    
    // Update selection state after filtering
    updateSelection();
}

// NEW: Clear filter function
function clearFilter() {
    const select = document.getElementById('select-1');
    const appointmentRows = document.querySelectorAll('.appointment-row');
    const filterInfo = document.getElementById('filterInfo');
    
    // Reset dropdown to "Select a service"
    select.value = 'all';
    
    // Show all rows
    appointmentRows.forEach(row => {
        row.classList.remove('hidden-row');
    });
    
    // Hide filter info
    filterInfo.style.display = 'none';
    
    // Update selection state
    updateSelection();
}

function goToCancelConfirmation() {
    if (selectedCount > 0) {
        // Store selected appointments in session storage or send via POST
        const selectedAppointments = [];
        const checkboxes = document.querySelectorAll('.row-checkbox:checked');
        
        checkboxes.forEach(checkbox => {
            const row = checkbox.closest('tr');
            if (!row.classList.contains('hidden-row')) {
                const appointmentData = {
                    time: row.cells[1].textContent,
                    name: row.cells[2].querySelector('strong').textContent,
                    nhs: row.cells[2].textContent.split('\n')[1]?.trim(),
                    dob: row.cells[3].textContent,
                    contact: row.cells[4].textContent,
                    service: row.cells[5].textContent,
                    status: row.cells[6].textContent.trim()
                };
                selectedAppointments.push(appointmentData);
            }
        });
        
        // Store in session storage for the confirmation page
        sessionStorage.setItem('selectedAppointments', JSON.stringify(selectedAppointments));
        sessionStorage.setItem('selectedCount', selectedCount.toString());
        
        // Navigate to confirmation page
        window.location.href = 'cancel-appointments-confirmation';
    }
}

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    updateSelection(); // Set initial button states
    console.log('NHS Appointments page loaded - Filter functionality enabled');
});
</script>
{% endblock %}